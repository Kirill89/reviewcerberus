name: CI

on:
  pull_request:
    branches: [ "*" ]

jobs:
  lint-and-test:
    runs-on: ubuntu-latest
    env:
      # Dummy credentials for config validation during test collection
      MODEL_PROVIDER: bedrock
      AWS_ACCESS_KEY_ID: dummy_key
      AWS_SECRET_ACCESS_KEY: dummy_secret
      AWS_REGION_NAME: us-east-1
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install Poetry
        run: pipx install poetry
      - name: Install dependencies
        run: poetry install
      - name: Run lint
        run: make lint
      - name: Run tests (excluding integration)
        run: poetry run pytest -v --ignore=tests/test_integration.py

  check-version:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Get version from pyproject.toml
        id: version
        run: |
          VERSION=$(grep -Po '(?<=^version = ")[^"]*' pyproject.toml)
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "Checking version: $VERSION"
      - name: Check if version exists on PyPI
        run: |
          PACKAGE_NAME="reviewcerberus"
          VERSION="${{ steps.version.outputs.VERSION }}"
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "https://pypi.org/pypi/${PACKAGE_NAME}/${VERSION}/json")
          if [ "$HTTP_STATUS" = "200" ]; then
            echo "::error::Version ${VERSION} already exists on PyPI. Please bump the version in pyproject.toml"
            exit 1
          elif [ "$HTTP_STATUS" = "404" ]; then
            echo "Version ${VERSION} is available"
          else
            echo "::warning::Unexpected response from PyPI (HTTP ${HTTP_STATUS}), skipping check"
          fi
